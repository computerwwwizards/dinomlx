# Build Process

The DINOMLX build process is designed to be incremental, cache-friendly, and optimized for performance. It follows a multi-stage pipeline:

## 1. Source Parsing

The compiler scans the `src` directory, parsing each HTML file (pages and templates).

*   **Pages**: `src/pages/*.html`
*   **Templates**: `src/templates/*.html` (and components)
*   **Candidates**: `src/candidates/*.css`

## 2. Dependency Resolution

For each component and page, the compiler resolves dependencies:

*   **Custom Components**: `c-component-name` tags are matched to their source template files.
*   **CSS Candidates**: Classes used in the template are collected.
*   **Dynamic Attributes**: `_c_` attributes and `{{ }}` expressions are processed.

## 3. IR Generation

The resolved components and pages are transformed into the [Intermediate Representation (IR)](./intermediate-representation.md).

*   **Hashing**: Each component instance is assigned a unique hash based on its content and usage.
*   **Data Structure**: The component tree is flattened into a map of hashes (e.g., `hash_index` -> `{ slots: ... }`).
*   **Localization**: i18n strings are extracted and keyed.

## 4. Critical CSS Extraction

This is a key performance feature of DINOMLX.

1.  **Above-the-Fold Analysis**: The compiler identifies components that are visible in the initial viewport. This is determined by explicit markup (e.g., `<c-above-the-fold>`) or configuration.
2.  **Reference Tracing**: Starting from the root page and any `above_the_fold` references, the compiler traces the dependency graph to find all used CSS candidates.
3.  **CSS Composition**: The CSS rules for these candidates are collected and deduplicated.
4.  **Inlining**: The resulting Critical CSS is inlined directly into the `<head>` of the final HTML page inside a `<style>` tag.
5.  **Deferral**: All other CSS (for components not visible initially or interactive states like `:hover`) is bundled into a separate CSS file (e.g., `deferable.css`) and loaded asynchronously.

## 5. HTML Generation

The final HTML files are generated by traversing the IR and stitching the content together.

*   **Slot Filling**: Content is injected into the appropriate slots.
*   **Localization**: The correct language strings are substituted for i18n placeholders.
*   **Asset Injection**: Scripts, deferable CSS links, and other assets are injected.

## Directory Structure (Output)

The final output is typically stored in the `dist` directory:

```
dist/
  index.html            # Final page with inlined Critical CSS
  about.html
  shared/
    deferable.css       # Non-critical CSS loaded asynchronously
  assets/               # Images, fonts, etc.
```

## Performance Considerations

*   **Incremental Builds**: Because the IR is hash-based, unchanged components do not need to be recompiled.
*   **Parallel Processing**: Parsing and IR generation can happen in parallel for different pages.
*   **Zero-Runtime Overhead**: The compilation happens at build time, resulting in static HTML that is fast to load and render.
